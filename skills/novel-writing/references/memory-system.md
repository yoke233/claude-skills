# 记忆系统参考

> 本文件是 SKILL.md 中项目结构和上下文策略的**权威补充说明**。如有冲突，以 SKILL.md 为准。

## 设计原则

- **零依赖**：纯文件夹 + .md，任何编辑器可操作
- **静态/动态分离**：世界设定（极少改）与角色状态（每章更新）分开
- **原子化**：每个实体一个文件
- **双层摘要**：完整版供作者、`摘要` 字段（≤200字）供 AI
- **按需加载**：写作时只加载必要切片，不全量灌入

## 目录结构

```
novel-memory/
├── 00-项目/                    # 元数据层
│   ├── 项目总览.md             # 一句话简介、核心冲突、目标字数
│   ├── 写作进度.md             # 各卷/章完成状态
│   ├── 变更日志.md             # 重大设定修改（何时、为何、影响）
│   ├── 待解决.md               # 设定矛盾、审查 WARN 项
│   └── 灵感池.md
├── 10-世界观/                  # 静态设定层
│   ├── 概述.md                 # 世界观一页纸
│   ├── 力量体系/
│   ├── 地理/
│   ├── 历史/
│   ├── 社会/
│   └── 规则/
├── 20-角色/                    # 动态层
│   ├── _角色索引.md
│   ├── 主角/
│   ├── 核心角色/
│   ├── 次要角色/
│   └── 已退场/                 # 死亡/永久离场
├── 25-势力/
│   ├── _势力索引.md
│   └── [每个势力一个文件]
├── 30-情节/
│   ├── 主线.md                 # 含「活跃情节线」和「已完结情节线」两区
│   └── 伏笔追踪表.md           # 全书级伏笔追踪（原 70-技法/）
├── 45-连续性/
│   └── 章节摘要总表.md         # 全书逐章摘要，滚动追加
├── 35-时间线/
│   ├── 世界历史线.md
│   ├── 主角经历线.md
│   └── 各卷时间线/
├── 40-大纲/
│   ├── 全书大纲.md
│   └── 卷X大纲.md              # 含「卷摘要」区（完卷后填写）
├── 50-正文/                    # 工作草稿（含元数据）
│   ├── 卷一/
│   │   ├── 章001.md             # 当前最新版本
│   │   ├── _历史/               # 版本快照（v1-初稿、v2-修订…）
│   │   └── ...
│   └── 卷二/
├── 60-素材/                    # 名字库、招式库、参考图等
├── 90-归档/                    # 废弃设定（不删除，移到这里）
├── 55-风格/
│   └── 风格指南.md             # 文风定位、标杆范文、禁忌风格（阶段〇·五创建）
└── _模板/
    ├── 角色模板.md
    ├── 章节模板.md
    ├── 势力模板.md
    ├── 地点模板.md
    ├── 风格指南模板.md
    └── 卷大纲模板.md

manuscript/                      # 与 novel-memory/ 同级
└── 卷一/                       # 定稿纯净正文（无元数据，可直接发布）
    └── 章001.md
```

### 命名规范

| 规则 | 理由 |
|------|------|
| 数字前缀 00/10/20... | 强制排序，任何文件管理器一致 |
| 角色名做文件名 | 搜索角色名直接定位文件 |
| `_` 前缀的索引文件 | 排在目录顶部，充当入口 |
| 正文三位数编号 章001/章002 | 自然排序，支持到 999 章 |
| `已退场/` 子文件夹 | 避免死角色干扰活跃角色检索 |

## 文件模板速查

完整模板在 skill 的 `assets/_模板/` 目录中。以下为核心字段速查。

### 角色模板

```yaml
---
名字/别名/身份/阵营/状态/首次出场/当前修为/摘要/最后更新
---
```

正文结构：基本信息 → 性格 → 背景 → 关系网络 → 能力与装备 → 角色弧线 → **动态状态**（逐章更新：位置/身体/情绪/已知信息/未知信息/持有物品） → 写作备注

### 章节模板

```yaml
---
章节号/所属卷/视角角色/场景地点/故事内时间/状态/字数/出场角色/涉及情节线/摘要/最后更新
---
```

正文结构：本章概要 → 场景列表 → 本章伏笔 → 本章引发的设定变更

### 卷大纲模板

```yaml
---
卷号/卷名/章节范围/主角起始状态/主角结束状态/核心事件/关键转折/状态/最后更新
---
```

正文结构：**卷摘要**（完卷后填写，≤500字） → 章节概要 → 冲突设计 → 伏笔规划 → 钩子分布 → 节奏规划 → 情绪事件 → 叙事装置

> 卷大纲中引用的教材路径（如"参考教材：冲突类型手册"）是给 Claude 的提示——Claude 会从 skill 内部的 `references/` 目录按需读取，这些路径不存在于用户项目中。

## 版本管理

### 版本快照策略

每个章节的工作文件（`50-正文/卷X/章XXX.md`）始终保持最新状态。关键节点保存完整快照到 `_历史/`：

| 时机 | 快照命名 | 触发 |
|------|---------|------|
| 初稿完成 | `章XXX-v1-初稿.md` | 进入多人审核前 |
| 每次修订后 | `章XXX-v{N}-修订{N-1}.md` | 审核意见修改后 |

快照包含完整文件（frontmatter + 元数据区块 + 正文），用于排查问题和对比差异。

### 定稿导出

章节定稿后，从工作文件中提取纯正文写入 `manuscript/`。去除的内容：
- YAML frontmatter
- `## 本章概要` / `## 场景列表` / `## 本章伏笔` / `## 本章引发的设定变更`

`manuscript/` 只存最终可读文本，供未来发布管线使用。

## AI 上下文管理

### 双层架构

```
完整知识库（作者用）     每个角色 500-2000 字
        ↓ 精炼
AI 摘要层（LLM 用）     每个角色 100-200 字（frontmatter 的「摘要」字段）
```

### 摘要字段写法

- **≤200 字**硬性限制
- 事实优先：身份 → 外貌识别特征 → 当前状态 → 性格
- 动态更新：角色状态重大变化后立即更新
- 反映截至当前进度的信息，不含未来剧情

### 上下文拼接策略（含 token 预算）

```
[永久上下文]  ~2500 tokens（固定，不随章节数增长）
  项目总览.md + 世界观概述
  55-风格/风格指南.md
  所有已完成卷的「卷摘要」（每卷 ≤500 字）

[本章上下文]  ~5000 tokens（有界，只加载必要切片）
  当前卷大纲（本章相关部分）
  45-连续性/章节摘要总表.md（一次读取获得全书概览）
  出场角色：只读 frontmatter「摘要」+ 「动态状态」区（不读全文！）
  涉及地点摘要
  30-情节/主线.md：只读「活跃情节线」一节

[技法约束]  ~1000 tokens（从卷大纲提取）
  节奏定位 + 伏笔/钩子指令 + 冲突推进备注
```

**加载红线**：上下文总量控制在 ~10000 tokens 以内（不含教材）。基础预算约 8500 tokens，剩余为深读角色/地点预留。

## 维护策略

### 写后即录（每章，8 步）

1. 填章节 frontmatter（字数、出场角色、摘要）
2. 追加章节摘要到 `45-连续性/章节摘要总表.md`
3. 更新角色动态状态区
4. 更新时间线
5. 登记伏笔变动
6. 同步卷大纲（钩子/情绪实际执行情况）
7. 更新活跃情节线进展
8. 导出定稿正文到 `manuscript/`

写后即录完成后执行**合规审查**（详见 `references/写后即录合规审查.md`）。

### 卷间审查（每卷完成后）

1. 一致性检查（角色/时间线/设定）
2. 技法审计（伏笔/钩子/冲突/情绪）
3. 生成卷摘要（≤500 字，写入卷大纲头部）
4. 更新与归档

### 变更日志格式

```markdown
## 2026-03-15 修炼体系名称调整
- **变更**：「练气→筑基→金丹」改为「聚灵→凝元→化丹」
- **原因**：避免雷同
- **影响**：卷一已发布不改，卷二起用新名
- **需更新**：[文件清单 + 勾选框]
```

### 防腐烂

- 最小化更新负担（每章 7 步 + 合规审查自动验证）
- 模板驱动（新建文件从 `_模板/` 复制）
- 索引文件充当看板
- 归档而非删除（降低决策疲劳）
