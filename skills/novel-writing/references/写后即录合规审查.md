# 写后即录合规审查

> **触发时机**：阶段二（写后即录）的 7 个更新步骤全部完成后。
>
> **目的**：机械化验证所有更新是否到位。审查员不需要理解剧情，只做存在性和一致性检查。
>
> **规则来源**：本审查执行 `references/lint-规则目录.md` 中的 `CH-FM-*` + `CH-SYNC-*` + `CH-CHECK-*` 规则。

---

## 执行方式

使用 Agent 工具启动 **1 个合规审查子代理**。该 agent 只有 Read/Grep/Glob 权限，**不允许修改任何文件**。

---

## 审查 agent prompt 模板

将 `{CH}` 替换为章节号（如 `001`），`{VOL}` 替换为卷目录名（如 `卷一`），`{ROOT}` 替换为项目根路径。

```
你是写后即录合规审查员。你的任务是验证第 {CH} 章的写后即录是否完整执行。
不需要评价内容质量，只做机械化的存在性和一致性检查。

门禁策略（来自 lint-规则目录.md）：
- error > 0 → BLOCKED
- error = 0 且 warn > 0 → PASS_WITH_WARNINGS
- 全部通过 → PASS

逐项执行以下检查，每项报告 PASS 或 FAIL + 具体原因：

## 检查清单

### CH-PATH：路径与命名
- [ ] [CH-PATH-001] 文件位于 `50-正文/卷X/` 目录下
- [ ] [CH-PATH-002] 文件名匹配 `章XXX.md` 格式（如 `章001.md`）

### CH-TPL：模板结构完整性
- [ ] [CH-TPL-001] 包含 4 个必要区块：`本章概要`、`场景列表`、`本章伏笔`、`本章引发的设定变更`
- [ ] [CH-TPL-002] 每个场景包含 `地点/出场角色/目标/冲突/结果` 5 个字段

### CH-FM：frontmatter 完整性
读取 `{ROOT}/50-正文/{VOL}/章{CH}.md` 的 frontmatter。
- [ ] [CH-FM-001] YAML 可正常解析
- [ ] [CH-FM-002] 必填字段齐全：`章节号/所属卷/视角角色/场景地点/故事内时间/状态/字数/出场角色/涉及情节线/摘要`
- [ ] [CH-FM-003] `状态` 为「定稿」
- [ ] [CH-FM-004] `摘要` ≤ 200 字
- [ ] [CH-FM-005] `字数` > 0
- [ ] [CH-FM-006] `出场角色` 列表非空

### CH-SYNC-001：章节摘要总表同步
读取 `{ROOT}/45-连续性/章节摘要总表.md`。
- [ ] 存在包含 `| {CH} |` 的行
- [ ] 该行摘要内容与 frontmatter 摘要一致（允许微调措辞）

### CH-SYNC-002：角色索引一致
- [ ] frontmatter `出场角色` 中每个角色在 `{ROOT}/20-角色/_角色索引.md` 中已登记

### CH-SYNC-003：情节线一致
- [ ] frontmatter `涉及情节线` 中每条情节线在 `{ROOT}/30-情节/主线.md` 中存在（活跃或已完结区均可）

### CH-SYNC-006：角色动态状态更新
从章节 frontmatter 的 `出场角色` 获取角色列表。
对每个出场角色，找到其角色文件（通过 `{ROOT}/20-角色/_角色索引.md` 定位）：
- [ ] 角色文件的「动态状态」区的「最后更新章节」= 第 {CH} 章
- [ ] 「当前位置」字段非空
- [ ] 「情绪状态」字段非空

### CH-SYNC-005：时间线同步
读取 `{ROOT}/35-时间线/主角经历线.md`（或对应时间线文件）。
- [ ] 存在第 {CH} 章相关的事件条目

### CH-SYNC-004：伏笔追踪一致性
读取当前卷大纲的伏笔规划，获取本章计划埋设/强化/回收的伏笔列表。
读取 `{ROOT}/30-情节/伏笔追踪表.md`。
- [ ] 卷大纲中计划本章埋设的伏笔，在追踪表「活跃伏笔」区有对应条目
- [ ] 卷大纲中计划本章回收的伏笔，在追踪表「已回收伏笔」区有对应条目
- [ ] 如无计划伏笔操作，标记 SKIP

### CH-SYNC-007：卷大纲同步
读取当前卷大纲。
- [ ] 钩子分布表中第 {CH} 章的行有实际执行记录（不是只有规划）
- [ ] 如有情绪事件计划，对应行已标记实际执行情况

### CH-SYNC-008：情节线更新
读取 `{ROOT}/30-情节/主线.md` 的「活跃情节线」区。
- [ ] 与本章相关的情节线有进展记录

### CH-CHECK-001：设定变更清单闭环
- [ ] 章节文件「本章引发的设定变更」区无未完成待办项（或已说明豁免）

## 输出格式

| Rule ID | Severity | 结果 | 说明 |
|---------|----------|------|------|
| CH-PATH-001 | error | PASS/FAIL | |
| CH-PATH-002 | warn | PASS/FAIL | |
| CH-TPL-001 | error | PASS/FAIL | 缺哪些区块？ |
| CH-TPL-002 | error | PASS/FAIL | 哪个场景缺字段？ |
| CH-FM-001 | error | PASS/FAIL | |
| CH-FM-002 | error | PASS/FAIL | 缺哪些字段？ |
| CH-FM-003 | error | PASS/FAIL | |
| CH-FM-004 | error | PASS/FAIL | |
| CH-FM-005 | error | PASS/FAIL | |
| CH-FM-006 | error | PASS/FAIL | |
| CH-SYNC-001 | error | PASS/FAIL | |
| CH-SYNC-002 | error | PASS/FAIL | 哪个角色未登记？ |
| CH-SYNC-003 | error | PASS/FAIL | 哪条情节线不存在？ |
| CH-SYNC-006 | error | PASS/FAIL | 哪个角色未更新？ |
| CH-SYNC-005 | warn | PASS/FAIL | |
| CH-SYNC-004 | error | PASS/FAIL/SKIP | |
| CH-SYNC-007 | warn | PASS/FAIL | |
| CH-SYNC-008 | warn | PASS/FAIL | |
| CH-CHECK-001 | warn | PASS/FAIL | |

门禁判定：error=X, warn=Y → BLOCKED / PASS_WITH_WARNINGS / PASS

如有 FAIL 项，列出需要补充的具体文件和内容。
```

---

## 执行规则

- 审查结果为 **BLOCKED** → 必须补充后重新审查，直到不再有 error
- **PASS_WITH_WARNINGS** → 记录 warn 项，不阻断进入下一章
- **PASS** → 直接进入下一章写作
- 合规审查 agent 只有 Read/Grep/Glob 权限，**不允许修改任何文件**
